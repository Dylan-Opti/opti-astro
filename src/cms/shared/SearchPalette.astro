---
// SearchPalette.astro - Search palette with dynamic search
---

<div
    x-data="searchPalette()"
    x-show="isOpen"
    x-cloak
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    @keydown.escape.window="isOpen = false"
    @open-command-palette.window="isOpen = true"
    class="fixed inset-0 z-50 overflow-y-auto p-4 sm:p-6 md:p-20"
    role="dialog"
    aria-modal="true"
>
    <!-- Overlay -->
    <div
        class="fixed inset-0 bg-white/75 backdrop-blur-sm"
        aria-hidden="true"
        x-show="isOpen"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-150"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
    >
    </div>

    <!-- Dialog panel -->
    <div
        class="ring-opacity-5 mx-auto max-w-2xl transform divide-y divide-gray-100 overflow-hidden rounded-xl bg-white shadow-2xl ring-1 ring-indigo-200 transition-all"
        @click.away="isOpen = false"
    >
        <!-- Search input -->
        <div class="relative">
            <svg
                class="pointer-events-none absolute top-3.5 left-4 h-5 w-5 text-gray-400"
                viewBox="0 0 20 20"
                fill="currentColor"
            >
                <path
                    fill-rule="evenodd"
                    d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z"
                    clip-rule="evenodd"></path>
            </svg>
            <input
                type="text"
                x-model="query"
                @input.debounce.300ms="search()"
                class="h-12 w-full border-0 bg-transparent pr-4 pl-11 text-gray-900 shadow-none outline-none placeholder:text-gray-400 focus:ring-0 focus:outline-none sm:text-sm"
                placeholder="Search..."
                role="combobox"
            />
        </div>

        <!-- Results -->
        <div class="flex divide-x divide-gray-100">
            <!-- Search results list -->
            <div
                class="max-h-96 min-w-0 flex-auto scroll-py-4 overflow-y-auto px-6 py-4"
            >
                <!-- Loading state -->
                <div
                    x-show="loading"
                    class="flex items-center justify-center py-8"
                >
                    <svg
                        class="h-8 w-8 animate-spin text-gray-400"
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                    >
                        <circle
                            class="opacity-25"
                            cx="12"
                            cy="12"
                            r="10"
                            stroke="currentColor"
                            stroke-width="4"></circle>
                        <path
                            class="opacity-75"
                            fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                        ></path>
                    </svg>
                </div>

                <!-- Error state -->
                <div
                    x-show="error"
                    class="flex flex-col items-center justify-center py-8 text-center"
                >
                    <svg
                        class="h-12 w-12 text-red-400"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                        ></path>
                    </svg>
                    <p class="mt-2 text-sm text-gray-500" x-text="error"></p>
                    <button
                        @click="search()"
                        class="mt-4 rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500"
                    >
                        Try again
                    </button>
                </div>

                <!-- Empty state -->
                <div
                    x-show="!loading && !error && query && results.length === 0"
                    class="px-6 py-14 text-center text-sm sm:px-14"
                >
                    <svg
                        class="mx-auto h-6 w-6 text-gray-400"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9.5a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"
                        ></path>
                    </svg>
                    <p class="mt-4 font-semibold text-gray-900">
                        No results found
                    </p>
                    <p class="mt-2 text-gray-500">
                        We couldn't find anything with that term. Please try
                        again.
                    </p>
                </div>

                <!-- Results list -->
                <div x-show="!loading && !error && results.length > 0">
                    <template x-for="result in results" :key="result.id">
                        <div
                            class="group flex cursor-pointer items-center gap-3 rounded-xl p-3 hover:bg-gray-50"
                            :class="{ 'bg-gray-50': selectedResult?.id === result.id }"
                            @click="selectResult(result)"
                        >
                            <!-- Icon based on type -->
                            <div
                                class="flex-none"
                                x-show="result.type !== 'person'"
                            >
                                <span
                                    class="inline-flex h-10 w-10 items-center justify-center rounded-lg"
                                    :class="{
                                        'bg-blue-50 text-blue-600': result.type === 'page',
                                        'bg-yellow-50 text-yellow-600': result.type === 'document'
                                    }"
                                >
                                    <svg
                                        x-show="result.type === 'page'"
                                        class="h-6 w-6"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                                        ></path>
                                    </svg>
                                    <svg
                                        x-show="result.type === 'document'"
                                        class="h-6 w-6"
                                        fill="none"
                                        viewBox="0 0 24 24"
                                        stroke="currentColor"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"
                                        ></path>
                                    </svg>
                                </span>
                            </div>

                            <!-- Person image -->
                            <img
                                x-show="result.type === 'person'"
                                :src="result.image"
                                :alt="result.title"
                                class="h-10 w-10 flex-none rounded-full"
                            />

                            <div class="min-w-0 flex-auto">
                                <p
                                    class="text-sm font-medium text-gray-900"
                                    x-text="result.title"
                                >
                                </p>
                                <p
                                    x-show="result.subtitle"
                                    class="truncate text-sm text-gray-500"
                                    x-text="result.subtitle"
                                >
                                </p>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Selected result details -->
            <div
                x-show="selectedResult && selectedResult.type === 'person'"
                class="hidden w-1/2 flex-none flex-col divide-y divide-gray-100 sm:flex"
            >
                <div class="flex-none p-6 text-center">
                    <img
                        :src="selectedResult?.image"
                        :alt="selectedResult?.title"
                        class="mx-auto h-16 w-16 rounded-full"
                    />
                    <h2
                        class="mt-3 font-semibold text-gray-900"
                        x-text="selectedResult?.title"
                    >
                    </h2>
                    <p
                        class="text-sm leading-6 text-gray-500"
                        x-text="selectedResult?.subtitle"
                    >
                    </p>
                </div>

                <div class="flex flex-auto flex-col justify-between p-6">
                    <dl
                        class="grid grid-cols-1 gap-x-6 gap-y-3 text-sm"
                        x-show="selectedResult?.metadata"
                    >
                        <template
                            x-for="(value, key) in selectedResult?.metadata"
                            :key="key"
                        >
                            <div class="grid grid-cols-1 gap-1">
                                <dt class="text-gray-500" x-text="key"></dt>
                                <dd class="text-gray-700">
                                    <template x-if="key === 'email'">
                                        <a
                                            :href="'mailto:' + value"
                                            class="text-indigo-600 hover:text-indigo-500"
                                            x-text="value"></a>
                                    </template>
                                    <template x-if="key === 'url'">
                                        <a
                                            :href="value"
                                            class="text-indigo-600 hover:text-indigo-500"
                                            x-text="value"></a>
                                    </template>
                                    <template
                                        x-if="key !== 'email' && key !== 'url'"
                                    >
                                        <span x-text="value"></span>
                                    </template>
                                </dd>
                            </div>
                        </template>
                    </dl>
                    <button
                        x-show="selectedResult?.type === 'person'"
                        type="button"
                        class="mt-6 w-full rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500"
                        @click="sendMessage(selectedResult?.title)"
                    >
                        Send message
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style is:global>
    [x-cloak] {
        display: none !important;
    }
</style>

<script is:inline>
    function searchPalette() {
        return {
            isOpen: false,
            query: '',
            results: [],
            selectedResult: null,
            loading: false,
            error: null,

            async search() {
                if (!this.query) {
                    this.results = [];
                    this.selectedResult = null;
                    return;
                }

                try {
                    this.loading = true;
                    this.error = null;

                    const response = await fetch(
                        `/api/search.json?q=${encodeURIComponent(this.query)}`
                    );
                    if (!response.ok) {
                        throw new Error('Failed to perform search');
                    }

                    const data = await response.json();
                    this.results = data.results;
                    this.selectedResult = null;
                } catch (err) {
                    this.error = err.message;
                    console.error('Error performing search:', err);
                } finally {
                    this.loading = false;
                }
            },

            selectResult(result) {
                this.selectedResult = result;
            },

            sendMessage(name) {
                alert(`Send message to ${name}`);
            },
        };
    }
</script>

<style>
    #search-palette {
        position: fixed !important;
        top: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        left: 0 !important;
        z-index: 9999 !important;
    }
</style>
