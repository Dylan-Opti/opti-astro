---
import Layout from "../layouts/Layout.astro";
import Components from "../components/cms/OnPageEditing/components/_Components.astro";
import Experiences from "../components/cms/VisualBuilder/experiences/_Experiences.astro";
import Pages from "../components/cms/OnPageEditing/pages/_Pages.astro";
import {IContentPayload} from "../services/shared/IContentPayload";
import {IBlankExperience, ILocales} from "../services/graphql/__generated/sdk";
import {optiDraftSdk} from "../services/graphql/getSdk";
import qs from "query-string";
import {getSeoData} from "../components/cms/VisualBuilder/experiences/ExperiencesHelper";

const previewPayload = qs.parse(Astro.url.search) as unknown as IContentPayload;

const optiResponse = await optiDraftSdk.contentById({
    key: previewPayload.key,
    loc: previewPayload.loc as ILocales,
    ver: previewPayload.ver,
});
const types = optiResponse._Content.items[0]?._metadata?.types;
const isComponentType = types?.includes("_Component");
const isExperienceType = types?.includes("_Experience");
const isPageType = types?.includes("_Page") && isExperienceType === false;
const {metaTitle, metaDescription} = await getSeoData(isExperienceType, isPageType, previewPayload)
---

<Layout title={metaTitle} description={metaDescription}>
    {!types &&
            <h1 class="text-5xl text-center">Welcome to the demo site!</h1>}
    {isComponentType &&
            <Components data={previewPayload}/>}
    {isExperienceType &&
            <Experiences data={previewPayload}/>}
    {isPageType &&
            <Pages data={previewPayload}/>}
</Layout>
<script src="/communicationinjector.js" is:inline></script>
<script>
    function contentSaved(event: any) {
        window.location = event.detail.previewUrl;
        //window.location.reload();
    }

    window.addEventListener("optimizely:cms:contentSaved", (event) =>
        contentSaved(event)
    );
</script>
