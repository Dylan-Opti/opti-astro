---
import Layout from "../layouts/Layout.astro";
import Components from "../components/cms/OnPageEditing/components/_Components.astro";
import Experiences from "../components/cms/VisualBuilder/experiences/_Experiences.astro";
import Pages from "../components/cms/OnPageEditing/pages/_Pages.astro";
import {CommonData} from "../components/common/CommonData";
import {ILocales} from "../services/graphql/__generated/sdk";
import {optiSdk} from "../services/graphql/getSdk";
const key = Astro.url.searchParams.get("key");
const loc = Astro.url.searchParams.get("loc");
const ver = Astro.url.searchParams.get("ver");
const preview_token = Astro.url.searchParams.get("preview_token");

const optiResponse = await optiSdk.contentById({
    contentId: key,
    lang: loc as ILocales,
    version: ver,
});
console.log(optiResponse);
const types = optiResponse._Content.items[0]._metadata.types;
const isComponentType = types.includes("_Component");
const isExperienceType = types.includes("_Experience");
const isPageType = types.includes("_Page") && isExperienceType === false;

const commonData: CommonData = {
    types: types,
    key: key,
    locale: loc,
    version: ver,
    previewToken: preview_token,
};
// console.log(commonData);
---

<Layout title="Preview">
    {isComponentType &&
            <Components data={commonData}/>}
    {isExperienceType &&
            <Experiences data={commonData}/>}
    {isPageType &&
            <Pages data={commonData}/>}
</Layout>
<script src="/communicationinjector.js" is:inline></script>
<script>
    function contentSaved(event: any) {
        window.location = event.detail.previewUrl;
        window.location.reload();
    }

    window.addEventListener("optimizely:cms:contentSaved", (event) =>
        contentSaved(event)
    );
</script>
